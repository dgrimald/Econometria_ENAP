---
title: "Métodos Quantitativos I"
subtitle: "Lista VI: Modelos em painel"
author: "Professores: Daniel Grimaldi e Arthur Bragança"
institute: "Mestrado Profissional em Avaliação e Monitoramento de Políticas Públicas"
date: "`r Sys.Date()`"
output: html_document
---

```{r echo=TRUE, warning=FALSE, message=FALSE}
# loading required packages
if(!require(knitr)){install.packages("knitr")}
if(!require(devtools)){install.packages("devtools")}
if(!require(tidyverse)){install.packages("tidyverse")}
if(!require(magrittr)){install.packages("magrittr")}
if(!require(data.table)){install.packages("data.table")}
if(!require(haven)){install.packages("haven")}
if(!require(openxlsx)){install.packages("openxlsx")}
if(!require(stargazer)){install.packages("stargazer")}
if(!require(knitr)){install.packages("knitr")}
if(!require(kableExtra)){install.packages("kableExtra")}
if(!require(formatR)){install.packages("formatR")}
if(!require(extraDistr)){install.packages("extraDistr")}
if(!require(ggdag)){install.packages("ggdag")}
if(!require(mvtnorm)){install.packages("mvtnorm")}
if(!require(estimatr)){install.packages("estimatr")}
if(!require(modelsummary)){install.packages("modelsummary")}
if(!require(plm)){install.packages("plm")}
if(!require(stargazer)){install.packages("stargazer")}
# source("https://github.com/dgrimald/Econometria_ENAP/raw/refs/heads/main/Aula%208/pgd.R")
source("pgd.R")
# source("https://raw.githubusercontent.com/dgrimald/Econometria_ENAP/refs/heads/main/Tema%20Beamer/themes_enap.R")
source("../themes_enap.R")
```

### *pgd*

Para fazer essa lista, você pode usar uma função chamada *pgd* (já carregada no chunk inicial dessa lista). Essa função aceita 11 argumentos, a saber:

i. *n.id*: um escalar que define a quantidade de indivíduos que compõem a amostra;
ii. *n.t*: um escalar que define o número de períodos no painel;
iii. *beta*: um vetor de tamanho 2, que controla o impacto de $x^1_{it}$ e $x^2_{it}$ em $y_{it}$;
iv. *delta*: um escalar que define o impacto da política P em $y_{it}$;
v. *mu_x*: um vetor de tamanho 2, que controla a média de $x^1_{it}$ e $x^2_{it}$;
vi. *sigma_x*: um vetor de tamanho 2, que controla o desvio-padrão de $x^1_{it}$ e $x^2_{it}$;
vii. *mu_alpha*: um escalar que define o valor médio de $\alpha$;
viii. *sigma_alpha*: um escalar que define o desvio-padrão de $\alpha$;
ix. *theta_1*: um escalar que define a intensidade da tendência temporal na formação de $\alpha_{it}$
x. *theta_2*: um escalar que define a intensidade da tendência temporal na formação de $\gamma_{it}$ 
xi. *zeta*: um escalar que define a importância de $\alpha$ para a decisão de acesso ao tratamento.

Se você ainda tiver dúvidas sobre a função, pode consultar os slides das aulas 8 e 9 na nossa página do Github.

### (1) Crie um caso teórico de avaliação de política pública

Busque um caso de referência e, inspirado nele, monte um caso teórico de avaliação de política pública (**caso base**). Lembre-se de:

 - citar pelo menos uma referência acadêmica que tenha servido de inspiração para o seu caso;
 - descrever sua variável dependente (apenas 1);
 - descrever cada uma das (exatamente) 2 variáveis observáveis envolvidas no caso;
 - descrever quais fatores não observáveis **podem** estar associados simultaneamente a variável dependente e o acesso à política.

### (2) Caso 1: RE como estimador não viesado

#### (2a) Construa uma base de dados simulados

Construa uma base de dados que simule o seu caso base e que tenha as seguintes características:

  - 5000 indivíduos;
  - 6 períodos de tempo;
  - o estimador de efeitos aleatórios (RE) é um estimador não viesado do impacto da política. 
  
Você pode usar a função *pgd* para fazer isso ou criar a sua própria programação. Usando o **chunk 2**, Dê o nome de **data_1** a essa base de dados que você criará e use a função *head* para incluir no seu relatório as 20 primeiras linhas de **data_1**. Lembre-se de usar o comando set.seed para que seu código possa ser reproduzido.

**Chunk 2: Cria a amostra denominada data_1**
```{r echo=TRUE, eval=TRUE}
set.seed(13) 
data_1 <- pgd(
  n.id = 5000, 
  n.t = 6, 
  beta = c(0.5, -0.5), 
  delta = -2, 
  mu_x = c(200, 500), 
  sigma_x = c(20, 80), 
  mu_alpha = 25, 
  sigma_alpha = 1,
  theta_1 = 0,
  theta_2 = 0,
  zeta = 0
)
head(data_1, 20)
```

#### (2b) Estime os modelos usados nas aulas 8 e 9

Usando o **Chunk 3**, crie uma função denominada **aplicar_modelos**. Essa função deve ter apenas 2 inputs: (i) **data.source**, que será um objeto do tipo data.frame; e (ii) nome_aluno, que você deverá preencher com seu nome. Esssa função será usada para estimar o impacto da política pública por meio dos seguintes modelos: Pooled OLS, RE, FE e TWFE. 

A sua função terá exatamente 3 outputs: (i) *nome*, que será o nome do aluno; (ii) *data*, que é a base de dados usada para as estimativas; e (iii) *results*, que é um objeto do tipo lista que armazenará os resultados dos 4 modelos propostos. 

Em seguinda, o **Chunk 4**, usará essa função sobre a base de dados criada no passo anterior (*Chunck 2*) e apresentará os resultados dos 4 modelos.

**Chunk 3: Estimando o impacto da política**
```{r echo=TRUE, eval=TRUE}
aplicar_modelos <- function(nome, data.source=data_1){
  
  data.source %<>% pdata.frame(index=c("id", "t"))
  ols_reg <- plm(y ~ x1 + x2 + P, data = data.source, model = "pooling")
  re_reg <- plm(y ~ x1 + x2 + P, data = data.source, model = "random")
  fe_reg <- plm(y ~ x1 + x2 + P, data = data.source, model = "within")
  twfe_reg <- plm(y ~ x1 + x2 + P, data = data.source, model = "within", effect = "twoways")

  
  # preparando objeto de saída da função
  return <- list("nome"=nome, "data"=data.source, "results"=list("ols"=ols_reg, "re"=re_reg, "fe"=fe_reg, "twfe"=twfe_reg))
}
```

**Chunk 4: Resultados - Caso 1**
```{r echo=TRUE, eval=TRUE}
estimativas <- aplicar_modelos(nome="Daniel Grimaldi", data.source=data_1)
estimativas$nome
head(estimativas$data)
summary(estimativas$results$ols)
summary(estimativas$results$re)
summary(estimativas$results$fe)
summary(estimativas$results$twfe)
```

### (3) Caso 2: FE como estimador não viesado

#### (3a) Construa uma base de dados simulados

Construa uma base de dados que simule o seu caso base e que tenha as seguintes características:

  - 5000 indivíduos;
  - 6 períodos de tempo;
  - o estimador de efeitos aleatórios (RE) é um estimador viesado do impacto da política; e
  - o estimador de efeitos fixos (FE) é um estimador não viesado do impacto da política.
  
Dentro  do **Chunk 5**, use a mesma função desenvolvida no *Chunk 1* para criar a amostra denonominada **data_2**, seguindo os parâmetros dados para esse Caso 2. Dentro do mesmo *Chunk 5*, use a função *head* para incluir no seu relatório as 20 primeiras linhas de **data_2**. Lembre-se de usar o comando set.seed para que seu código possa ser reproduzido.

**Chunk 5: Cria a amostra denominada data_2**
```{r echo=TRUE, eval=TRUE}
set.seed(13) 
data_2 <- pgd(
  n.id = 5000, 
  n.t = 6, 
  beta = c(0.5, -0.5), 
  delta = -2, 
  mu_x = c(200, 500), 
  sigma_x = c(20, 80), 
  mu_alpha = 25, 
  sigma_alpha = 1,
  theta_1 = 0,
  theta_2 = 0,
  zeta = 1
)
head(data_2, 20)
```

#### (2b) Estime os modelos usados nas aulas 8 e 9

Usando o **Chunk 6**, use a função **aplicar_modelos** sobre a amostra **data_2** e apresente os resultados das 4 estimativas.

**Chunk 6: Estimando o impacto da política**
```{r echo=TRUE, eval=TRUE}
estimativas <- aplicar_modelos(nome = "Daniel Grimaldi", data.source = data_2)
```

**Chunk 7: Resultados - Caso 2**
```{r echo=TRUE, eval=TRUE}
estimativas$nome
head(estimativas$data)
summary(estimativas$results$ols)
summary(estimativas$results$re)
summary(estimativas$results$fe)
summary(estimativas$results$twfe)
```

### (4) Quais modelos estimam o impacto verdadeiro da política no Caso 1? E no caso 2? Explique as diferenças entre os dois casos.

No primeiro caso, todos os modelos (Pooled OLS, RE, FE e TWFE) estimam o impacto verdadeiro da política - definido pelo parâmetro $\delta$ da função PGD. Isso ocorre porque a variável não observável do modelo ($\alpha$) não influencia a adesão à política pública - visto que o parâmetro zeta da função PGD foi definido como zero. Nesses contextos, poderá haver diferença de eficiência entre os modelos estimados, dependendo das características de $\alpha$. Contudo, não haverá viés nas estimações de nenhum dos modelos.

No segundo caso, o modelo de Efeitos Fixos (FE) e o TWFE estimam o impacto verdadeiro da política. Isso ocorre porque agora a variável não observável é fixa no tempo e afeta a adesão à política. Tanto o FE quanto o TWFE são capazes de controlar quaisquer fatores não observados e que sejam fixos no tempo. 


### (5) Considerando o contexto real da sua política, qual caso teórico te parece mais factível? Justifique sua resposta.

R: De forma geral, sempre a adesão à política não definida por elementos aleatórios (como uma loteria) existirão variáveis não observáveis que influenciam a decisão de adesão dos beneficiários. Por isso, modelos que ao menos consigam controlar por variáveis não observáveis fixas no tempo tendem a ser mais factíveis.
